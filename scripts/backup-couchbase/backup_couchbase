#!/bin/bash

if [ -z $1 ]; then
	echo "Ip address is required as a first argument"
	exit
fi 


DATE=$(date +%Y%m%d%H%M)
COUNTER=0
mkdir /tmp/backup_couchbase
for i in `curl http://$1:8091/pools/default/buckets 2> /dev/null | python -mjson.tool | grep -v 'hostname' | grep 'name' | awk -F\" '{print \$4}'` ; do	
	echo "Backing up $i"
	#Check for view, otherwise install it
	/usr/bin/curl "http://$1:8092/$i/_design/_all/_view/all?connection_timeout=60000" 2> /dev/null | grep -q 'not_found'
	if [ $? -eq 0 ]; then
		curl -X PUT -H 'Content-Type: application/json' http://Administrator:Administrator@$1:8092/$i/_design/_all -d @view	
	fi 
	#Fecthing data
	/usr/bin/curl "http://$1:8092/$i/_design/_all/_view/all?connection_timeout=60000" 2> /dev/null > /tmp/backup_tmp 	
	echo python /opt/backup-scripts/backup_memc.py -a $1:8091 -b $i -f /tmp/backup_tmp -o /tmp/backup_couchbase/backup_$i
	python /opt/backup-scripts/backup_memc.py -a $1:8091 -b $i -f /tmp/backup_tmp -o /tmp/backup_couchbase/backup_$i
done

#packaging data
tar cfz /tmp/backup_$DATE.tar.gz /tmp/backup_couchbase/

#cleaning up
rm -rf /tmp/backup_couchbase
rm /tmp/backup_tmp

#Done
echo 'Backup done'
